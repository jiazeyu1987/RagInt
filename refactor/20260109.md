# RagInt 上线/交付重构计划（2026-01-09）

目标：在不牺牲现有演示能力的前提下，把系统提升到“可部署、可观测、可回归、可交接”的工程化状态。

## 0. 范围与原则

- 范围：`backend/`（Flask API + 编排）、`fronted/`（React UI）、部署/交付脚手架（Docker/CI/文档）、最小测试与接口契约。
- 不做：业务能力大改、模型效果优化、UI 大改（除非为可维护性/稳定性必须）。
- 原则：
  - 先“可控上线”（配置、密钥、部署、监控、回滚）再“结构优化”（拆分热点）。
  - 任何重构都要可验证：至少有 smoke test / build / CI 或手工验收步骤。
  - 以边界稳定为目标：API 契约、provider 接口、状态后端接口稳定，内部可迭代。

## 1. 现状风险清单（上线/交付视角）

- 进程内状态：取消/限流/事件等如果仅在内存，多进程/多实例会不一致。
- 配置与密钥：若仍依赖本地文件/硬编码，交付到不同环境会失控且有泄露风险。
- 热点文件过大：TTS provider/编排集中会阻碍多人并行开发与问题定位。
- 缺少契约与回归：没有最小的接口说明与自动化校验，交接后回归成本极高。

## 2. 里程碑与交付物

### Milestone A（P0）：上线基础“可部署/可配置/可运行”

交付物：
- 后端启动入口标准化（WSGI/app factory），支持环境变量配置（host/port/debug/cors/config path）。
- 前端后端地址通过环境变量/构建参数注入（多环境切换不改代码）。
- `.gitignore` 与产物清理，确保仓库可 clone、可 CI。

验收标准：
- 本地/服务器能按文档一键启动。
- 不修改代码即可切换 dev/staging/prod 的后端地址与密钥。

### Milestone B（P1）：拆分复杂度热点（多人维护核心）

交付物：
- 后端 TTS provider 插件化：
  - `providers/*` 每个 provider 独立文件与接口
  - registry 统一选择/回退/日志
- 编排（Orchestrator）按步骤拆分：
  - `intent -> prompt(guide/constraints) -> rag/agent -> text_clean/segment -> stream out`
  - 让每步可单测、可替换、可观测
- 前端 App 编排与设置状态下沉：
  - `useAppSettings`/`useClientId`/（可选）`useReducer+Context` 把状态域拆清晰

验收标准：
- 新增一个 TTS provider 不需要改动“巨型文件”，只新增 provider + registry 注册。
- 编排关键步骤可在日志/事件中定位（每步有明确的 event/timing）。
- `npm build` 稳定通过。

### Milestone C（P2）：生产化（多实例一致性、观测、交付链路）

交付物：
- 状态后端抽象与 Redis 实现（可选启用）：
  - cancel / rate limit / events 支持跨进程一致
  - 失败策略：Redis 短暂故障不应导致整体不可用（关键路径 fail-open 或降级）
- 配置/密钥环境变量覆盖：
  - 允许 `RAGFLOW_API_KEY`、`BAILIAN_API_KEY` 等通过 env 注入
  - 配置文件保留占位符/默认值，避免泄露
- 交付形态：
  - `backend` Dockerfile（含必要 runtime，如 ffmpeg）
  - `fronted` Dockerfile（产物静态化，用 nginx 提供）
  - `docker-compose.yml`（可本地复现生产启动）
- CI：
  - 前端 build
  - 后端 import smoke
  - 最小 pytest（至少覆盖 request_id/client_id 解析等公共逻辑）

验收标准：
- `docker compose up --build` 能跑通（前端可访问、后端可响应 health/status）。
- CI 在 PR 上自动执行并可通过。
- Redis 开/关两种模式都能启动。

### Milestone D（P3）：接口契约与回归覆盖（交接“可维护”收尾）

交付物：
- OpenAPI（最小但可信）：
  - `/api/openapi.json` 输出（或静态文件托管）
  - 覆盖核心端点：`/api/ask`（SSE）、`/api/text_to_speech`、`/api/speech_to_text`、`/api/cancel`、`/api/status`、`/api/events`
- 端到端回归清单（文档）：
  - 语音录制 -> ASR -> ask -> SSE -> 分段 -> TTS 播放
  - cancel 与中断策略（用户打断/新请求覆盖/播放中断）
-（可选）轻量 E2E：
  - 使用脚本或最小 harness 调用 ask/tts 流并校验响应结构

验收标准：
- 新团队成员在 1 小时内可完成本地启动+核心流程跑通。
- 接口变更可通过 OpenAPI/测试及时暴露。

## 3. 环境变量规范（建议）

后端（建议前缀 `RAGINT_`）：
- `RAGINT_HOST` / `RAGINT_PORT` / `RAGINT_DEBUG`
- `RAGINT_CORS_ORIGINS`（逗号分隔）
- `RAGINT_CONFIG_PATH`（配置文件路径）
- `RAGINT_STATE_BACKEND=memory|redis`
- `RAGINT_REDIS_URL`（如 `redis://host:6379/0`）
- `RAGINT_REDIS_PREFIX`（隔离不同环境数据）

密钥/第三方：
- `RAGFLOW_API_KEY`、`RAGFLOW_BASE_URL`、`RAGFLOW_DATASET_NAME`、`RAGFLOW_DEFAULT_CONVERSATION_NAME`
- `BAILIAN_API_KEY`、`DASHSCOPE_API_KEY`（按实际启用）

前端：
- `REACT_APP_BACKEND_URL`（构建期注入）

## 4. 验收与交接清单（交付时必须提供）

- 文档：
  - 本地启动（含依赖：ffmpeg、redis 可选）
  - 生产部署建议（单机/多实例、是否启用 redis）
  - 常见故障排查（RAGFlow 连接、TTS provider、音频白噪/格式问题）
- 安全：
  - 仓库不包含真实密钥
  - `.env.example` 提供变量示例
- 运维：
  - 日志中包含 `request_id` / `client_id`
  - 关键指标/事件：首字、首段、tts首包、取消原因、错误栈

