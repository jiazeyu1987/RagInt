# 运维交付操作手册（SD-6 / SD-10）

本文用于交付现场运维人员：快速启动、检查系统健康、导出日志/事件、执行一键诊断与常见排障。

## 1. 启动方式（开发机/演示机）

1) 启动后端（默认端口 `8000`）
- 进入仓库根目录 `d:\ProjectPackage\RagInt`
- 运行：`python backend/app.py`

2) 启动前端（默认端口 `3000`）
- 进入 `fronted`
- 安装依赖：`npm install`
- 启动：`npm start`

## 2. 运行健康检查（必做）

1) 后端存活：打开 `http://localhost:8000/api/health`
- 关注字段：`ok`、`ragflow_connected`、`asr_loaded`、`uptime_s`

2) 一键诊断（后端）：打开 `http://localhost:8000/api/diag`
- 关注字段：
  - `deps.ffmpeg.found`：ASR 音频预处理依赖（ffmpeg）
  - `ragflow.connected`：RAGFlow 是否连接成功
  - `asr.funasr_loaded`：本地 ASR 模型是否已加载
  - `log.exists`：后端日志文件是否存在

3) 一键诊断（前端 UI）：在页面右侧「调试面板」->「一键诊断」点击「运行诊断」
- 同时会显示浏览器侧音频设备枚举数量与麦克风权限状态（`mic: granted/prompt/denied`）

## 3. 日志导出（交付必备）

1) 下载完整后端日志
- 打开 `http://localhost:8000/api/logs/download`

2) 查看后端日志 tail（默认 256KB）
- 打开 `http://localhost:8000/api/logs?tail_kb=256`
- 可调：`tail_kb=64/128/512/1024`（最大 2048）

## 4. 事件导出（SD-6：可复盘的时间线）

1) 导出一次问答/讲解的事件（NDJSON）
- 在右侧「调试面板」->「事件时间线」-> 点击「NDJSON」
- 或直接打开：`http://localhost:8000/api/events?request_id=<request_id>&limit=500&format=ndjson`

2) 典型排障时看哪些事件
- `ask_received / rag_first_text / first_tts_segment / tts_first_audio / play_end`：端到端延迟与卡点定位
- `cancel`：是否被打断、打断原因
- `tts_audio_abnormal`：前端检测到音频异常并降级为“仅文本”

## 5. 展厅控制体验（操作说明）

### 5.1 按钮
- 「开始讲解」：从第 1 站开始
- 「继续讲解 / 恢复连续讲解」：从当前站点继续（若勾选“连续讲解”，会恢复连续模式）
- 「暂停」：立即停止当前播报/回答，并把讲解状态标记为“已暂停”
- 「下一站 / 上一站」：切换站点并触发讲解
- 误触保护：当正在播报/回答时，切站/开始/继续需要“再次点击确认”

### 5.2 热键（输入框未聚焦时生效）
- `Esc`：打断（停止当前回答/播报）
- `P`：暂停
- `C`：继续讲解
- `N`：下一站
- `B`：上一站
- `S`：开始讲解

## 6. 多人围观队列（策略说明）

- 勾选「多人围观」后，问题会进入队列；空闲时自动从队列取下一条提问。
- 高优先级问题可打断当前回答，但有冷却时间（约 4 秒），避免频繁打断导致体验崩坏。
- 右侧「围观队列」支持“立即回答/移除”进行现场控场。

## 7. 离线播报（无硬件/无 SLAM 预案）

- 页面顶部「离线播报」会按预录音清单顺序播放整套讲解（用于无网络/无 RAG/无 SLAM 的临时降级）。
- 后端读取清单：`backend/data/offline/manifest.json`
- 音频文件放置：`backend/data/offline/audio/`

## 8. 常见问题（快速定位）

1) 前端能打开但没有声音
- 先在「一键诊断」确认 `音频设备`数量与麦克风权限
- 查看事件是否出现 `tts_audio_abnormal`（会自动降级为仅文本）

2) ASR 识别一直为空
- `api/diag` 查看 `deps.ffmpeg.found` 与 `asr.funasr_loaded`
- 查看 `api/logs?tail_kb=256` 是否有 `ffmpeg_convert_failed` 或 `asr_failed`

3) RAG 没响应/一直转圈
- `api/diag` 查看 `ragflow.connected` 与 `ragflow.list_chats.error`
- 查看 `api/logs` 是否有 `RAGFlow初始化失败`

