# 软件需求

## 1. 软件边界

本项目软件 = 前端（控制台/讲解UI/调试面板） + 后端（编排/状态/接口） + 对接（知识库/语音识别/语音合成/移动底盘或导航接口） + 数据（配置/日志/历史问答）。

## 2. 功能需求（FR）

### FR-0 系统状态机与状态约束（必须）
- 系统需具备明确的全局状态定义（如 IDLE / MOVING / ARRIVED / EXPLAINING / QA / ERROR）。
- 所有核心操作（讲解、问答、移动、播报）必须受当前状态约束。
- 非法状态组合需被拒绝并记录日志（如 MOVING 状态下禁止进入讲解）。
- 状态切换需具备单一入口，避免并发状态不一致。
- 所有异步链路必须绑定 task_id，返回时校验，否则丢弃
  
### FR-1 连续讲解
- 支持“开始/暂停/继续/下一站/上一站/跳站/重置”
- 支持路线配置（站点顺序）与每站讲解时长（可选：目标字数作为辅助）
- 支持承接策略：上一站结束与下一站开头尽量自然，减少重复欢迎/过渡话术
- 到站后自动触发该站讲解（移动与讲解联动）

### FR-2 观众问答（打断机制）
- 新问题提交即取消旧的流程
- 旧流程停止：知识库请求停止、语音合成生成与播放停止
- 问答结束后支持“继续讲解”（从当前站补充或进入下一站）
- 系统需定义操作优先级（如：人工控制 > 问答 > 讲解 > 移动）。
- 高优先级操作触发时，低优先级流程必须可被幂等取消，且不会留下残留音频或任务
- 系统需避免机器人自身播报音频被语音识别模块作为有效输入（如通过 AEC、音频通道隔离或逻辑屏蔽）。
- 仅当系统判定“稳定问题输入成立”并自动提交问题后，才视为一次有效打断：
  - 必须立即终止当前讲解流程；
  - 必须停止语音合成与播放；
  - 并进入问答（QA）状态。
- 单次唤醒但未形成稳定问题输入，不得中断讲解流程。

### FR-3 语音输入（语音识别）
- 中文识别可用、延迟可接受（以现场可用为准）
- 识别失败要有语音提示(再说一遍/我没听清)
- 支持关键词唤醒机制（Wake Word），仅在唤醒成功后进入语音识别流程，以减少环境噪声与误触发。
- 唤醒与问答需受系统状态约束，仅在允许的业务状态下生效（如讲解中/到站后/空闲态）。
- VAD/端点检测必须可配置；支持最大录音时长与自动截断；支持讲解时 barge-in（打断播报的策略）
- 播放期间 ASR gate 策略与优先级
- 唤醒词命中后，系统进入语音监听状态，对当前播报执行降音（ducking），但不立即终止讲解流程。
- 系统需基于语音活动检测（VAD）与端点判定，自动判断语音输入是否构成“稳定问题输入”。
- 当稳定问题输入判定成立时，系统应自动提交该问题并进入问答流程，无需人工确认。
- 若唤醒后在设定时间内未检测到稳定问题输入（如 3–5 秒），系统应退出监听状态并恢复正常讲解音量。

### FR-4 语音播报（语音合成）
- 流式播放（边合成边播），避免白噪音与卡顿
- 支持关闭播报
- 支持 debug：首包延迟、chunk 统计
### FR-5 移动与站点到达
- 支持按站点移动：`go_to(站点)` / `cancel()` / `get_state()`（最小闭环）
- 到站判定要可配置（到位阈值/停靠点），到站成功后再进入讲解
- 移动失败或超时要提示并允许人工介入，不进入“假到站讲解”
- 打断时可取消移动（避免问答与移动冲突）
- 导航/底盘对接通过“导航适配器”实现，接口与字段以系统详细设计为准（见 `doc/robot/04-detailed-design.md`）
- 到站判定需至少包含：距离阈值 + 停留时间（如连续 N 秒满足阈值）。
- 若在设定超时时间内未满足到站条件，应进入“到站失败”状态，而非默认成功

### FR-6 运维与可观测性
- 后端提供端口：返回关键阶段耗时与当前状态
- 前端提供调试面板

### FR-7 历史与复用
- 记录提问与回答；同问题计数聚合；点击历史可回填输入框

### FR-8 配置与站点管理
- 支持配置文件化管理：站点顺序、每站讲解时长、站点与导航点位的映射、外部服务地址与开关
- 支持导入/导出/备份配置；配置变更后无需改代码即可生效（允许重启服务生效）
- 站点数据至少包含：`stop_id/stop_name/duration_s`，并能与导航系统的站点 ID 对齐

### FR-9 降级与恢复
- 外部服务不可用（知识库/语音识别/语音合成 任一）时，系统应给出明确提示，并切换到可用模式：
  - 讲解：本地脚本讲解
  - 问答：可以从历史问答记录里查找，如果没有,显示网络不可用避免胡编；允许稍后重试
- 服务恢复后可自动或手动恢复到正常模式
- 外部服务（ASR / TTS / 知识库）需具备超时、失败计数与健康检查机制。
- 连续失败超过阈值时，应进入降级模式并明确提示原因。
- 不允许无限等待外部服务响应。

### FR-10 知识库接入与内容更新
- 支持对接知识库平台的会话的选择与切换（配置化）。
- 支持内容更新后的生效机制：更新知识库后，业务侧无需改代码即可使用新内容（允许重启服务生效）。

### FR-11 数据清洗与导入工具链
- 提供一套可复用的数据清洗与导入工具链（脚本/命令/文档皆可），覆盖：抽取、去噪、去重、分段、元数据标注、质量抽检。
- 支持增量导入（新增/更新文档），并保留版本号/日期，便于回滚与对比。
- 清洗与导入过程需可记录（输入文件列表、输出条目数、失败原因）。

### FR-12 权限与密钥管理
- 业务服务使用只读凭证访问知识库；导入/管理使用独立账号/凭证，避免混用。
- 支持密钥轮换：更换凭证后旧凭证可失效；支持在配置中切换。
- 运行中不得将密钥明文写入日志；日志仅记录凭证标识或前缀（如需）。

### FR-13 知识库平台部署与权限治理
- 知识库平台需可部署（内网或本机），并提供管理入口用于数据集/文档管理与权限配置。
- 至少支持三类角色：管理员、内容运营、只读访问（业务服务）。
- 支持审计留痕：记录导入/更新/删除等操作（时间、操作者、对象），并可导出。
- 支持备份与恢复（数据集导出/配置导出），便于版本回滚与现场快速恢复。

### FR-14 实施计划与人力投入
- 需给出软件实施计划（阶段划分、里程碑、每阶段交付物），并估算人力投入（人月）。
- 人力估算需能与软件详细设计条目对应，作为预算与排期依据。

## 3. 非功能需求
- NFR-1 延迟：首句播报尽可能 < 6s（现场网络允许时）
- NFR-2 稳定：长时间运行（>8h）不内存泄漏，不累积连接
- NFR-3 可维护：代码逻辑清晰
- NFR-4 可扩展：预留培训/教学接口方便日后扩展
- NFR-5 安全：配置与密钥最小暴露、关键操作可审计、敏感内容不外泄
