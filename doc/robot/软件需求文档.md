
# 软件需求

## 1. 软件边界

本项目软件 = 前端（控制台 / 讲解 UI / 调试面板）
+ 后端（编排 / 状态 / 接口）
+ 对接（知识库 / 语音识别 / 语音合成 / 移动底盘或导航接口）
+ 数据（配置 / 日志 / 历史问答）。

---

## 2. 功能需求（FR）

### FR-0 系统状态机与状态约束（必须）
- 系统需具备明确的全局状态定义：`IDLE / MOVING / ARRIVED / EXPLAINING / QA / ERROR`。
- 所有核心操作（讲解、问答、移动、播报）必须受当前状态约束。
- 非法状态组合需被拒绝并记录日志（如 `MOVING` 状态下禁止进入讲解）。
- 状态切换需具备单一入口，避免并发状态不一致。
- 所有异步链路必须绑定 `task_id`；返回时若 `task_id` 不匹配当前任务，必须直接丢弃，不得影响系统状态或输出。

---

### FR-1 连续讲解
- 支持“开始 / 暂停 / 继续 / 下一站 / 上一站 / 跳站 / 重置”。
- 支持路线配置（站点顺序）与每站讲解时长（可选：目标字数作为辅助）。
- 支持讲解承接策略，避免相邻站点重复欢迎或过渡话术。
- 仅在到站判定成功后，才可自动触发该站讲解（移动与讲解联动）。

---

### FR-2 观众问答（打断机制）
- 仅当系统判定“**稳定问题输入成立并自动提交**”后，才视为一次有效问答打断。
- 新问题在自动提交后，必须立即取消当前低优先级流程。
- 问答进入时，必须停止当前讲解流程以及对应的语音合成与播放。
- 问答结束后，系统可从当前站点继续讲解，或进入下一站。
- 系统需定义操作优先级：**人工控制 > 问答 > 讲解 > 移动**。
- 高优先级操作触发时，低优先级流程必须支持幂等取消。
- 单次唤醒但未形成稳定问题输入，不得中断讲解流程。
- **在 QA 状态期间，即使满足到站条件，也不得自动触发讲解。**

---

### FR-3 语音输入（语音识别）
- 支持中文语音识别，延迟以现场可用为准。
- 识别失败需提供明确语音或提示音反馈。
- 支持关键词唤醒（Wake Word），未唤醒不得进入语音识别流程。
- 唤醒与问答仅在允许的系统状态下生效（`EXPLAINING / ARRIVED / IDLE`）。
- 支持语音活动检测（VAD）与端点检测的参数化配置（起始阈值、静音阈值、最大录音时长）。
- 支持讲解过程中的 barge-in 行为。
- 播放期间必须启用 ASR gate，避免机器人自身播报被识别。
- 唤醒成功后进入监听态，对当前播报执行降音（ducking），但不立即终止讲解流程。
- 系统需基于 VAD 与端点规则自动判定“稳定问题输入”。
- 稳定问题输入成立后，系统应自动提交问题并进入问答流程，无需人工确认。
- 若唤醒后在设定时间内未检测到稳定问题输入，应退出监听态并恢复讲解音量。

---

### FR-4 语音播报（语音合成）
- 支持流式语音合成与播放，避免白噪音与明显卡顿。
- 支持播报关闭。
- 提供调试信息：首包延迟、音频 chunk 统计。

---

### FR-5 移动与站点到达
- 支持按站点移动：`go_to / cancel / get_state`。
- 到站判定需可配置，至少包含距离阈值与连续停留时间。
- 未满足到站条件或超时，必须进入到站失败状态，不得触发讲解。
- 移动失败需明确提示并允许人工介入。
- 在 QA 状态期间，移动任务默认继续执行。
- **仅在人工明确触发停止，或系统进入 `ERROR` 状态时，才可取消当前移动任务。**
- 导航与底盘需通过统一导航适配器对接。

---

### FR-6 运维与可观测性
- 后端需提供接口输出关键阶段状态与耗时。
- 前端需提供调试与状态监控面板。

---

### FR-7 历史与复用
- 记录问答历史并支持同问题聚合统计。
- 历史问题可回填至输入框。

---

### FR-8 配置与站点管理
- 支持配置文件化管理站点顺序、讲解时长、导航映射与外部服务开关。
- 支持配置导入、导出与备份。
- 配置变更允许通过重启生效。
- 站点数据至少包含：`stop_id / stop_name / duration_s`。

---

### FR-9 降级与恢复
- 外部服务（ASR / TTS / 知识库）不可用时，系统需明确提示并进入降级模式。
- 降级模式下：
  - 讲解使用本地脚本；
  - 问答仅基于历史记录，或明确提示服务不可用。
- 外部服务需具备超时、失败计数与健康检查机制。
- 连续失败超过阈值必须触发降级，不得无限等待。
- 服务恢复后支持人工或自动恢复。

---

### FR-10 知识库接入与内容更新
- 支持配置化选择与切换知识库会话。
- 知识库内容更新后允许通过重启生效，无需改代码。

---

### FR-11 数据清洗与导入工具链
- 提供数据清洗与导入工具链，支持抽取、去噪、去重、分段、标注与抽检。
- 支持增量导入与版本记录。
- 导入过程需记录输入、输出与失败原因。

---

### FR-12 权限与密钥管理
- 业务服务仅使用只读凭证访问知识库。
- 导入与管理使用独立账号与凭证。
- 支持密钥轮换，日志中不得记录明文密钥。

---

### FR-13 知识库平台部署与权限治理
- 知识库平台需支持本地或内网部署。
- 至少支持管理员 / 内容运营 / 只读访问三类角色。
- 支持审计、备份与恢复。

---

### FR-14 实施计划与人力投入
- 提供实施计划、阶段划分与里程碑。
- 估算人力投入并与详细设计条目对应。

---

## 3. 非功能需求

- NFR-1 延迟：首句播报尽可能 < 6 秒（现场网络允许时）。
- NFR-2 稳定：连续运行 > 8 小时，不出现内存泄漏或连接累积。
- NFR-3 可维护：代码结构清晰，职责明确。
- NFR-4 可扩展：预留培训、教学等扩展接口。
- NFR-5 安全：配置与密钥最小暴露，关键操作可审计。
