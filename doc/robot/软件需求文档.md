# 软件需求

## 1. 软件边界

本项目软件 = 前端（控制台/讲解UI/调试面板） + 后端（编排/状态/接口） + 对接（RAG/ASR/TTS/移动底盘或导航接口） + 数据（配置/日志/历史问答）。

## 2. 功能需求（FR）

### FR-1 连续讲解
- 支持“开始/暂停/继续/下一站/上一站/跳站/重置”
- 支持路线配置（站点顺序）与每站讲解时长（可选：目标字数作为辅助）
- 支持承接策略：上一站结束与下一站开头尽量自然，减少重复欢迎/过渡话术
- 到站后自动触发该站讲解（移动与讲解联动）

#### FR-1 验收条款
- 暂停口径：点击“暂停”后，必须立即停止当前播报/生成，并保持当前站点进度不丢失
- 继续口径：点击“继续讲解”后，从当前站点继续；若启用了“连续讲解”，继续后需恢复连续模式并继承上一轮的连续讲解设置
- 切站口径：点击“下一站/上一站/跳站”会切换到目标站点并触发该站讲解（不要求移动对接闭环时也可先走“讲解切站”）

### FR-2 观众问答
- 新问题提交即取消旧 request（前后端一致）
- 旧流程停止：RAG SSE 停止、TTS 生成与播放停止、ASR 中断
- 问答结束后支持“继续讲解”（从当前站补充或进入下一站）

### FR-3 语音输入
- 中文识别可用、延迟可接受（以现场可用为准）

### FR-4 语音播报
- 流式播放（边合成边播），避免白噪音与卡顿
- 支持关闭播报（仅文字）
- 支持 debug：首包延迟、chunk 统计
### FR-5 移动与站点到达
- 支持按站点移动：`go_to(站点)` / `cancel()` / `get_state()`（最小闭环）
- 到站判定要可配置（到位阈值/停靠点），到站成功后再进入讲解
- 移动失败或超时要提示并允许人工介入，不进入“假到站讲解”
- 打断时可取消移动（避免问答与移动冲突）
- 导航/底盘对接通过“导航适配器”实现，接口与字段以系统详细设计为准（见 `doc/robot/系统详细设计.md`）

### FR-6 运维与可观测性
- 后端提供状态端口：返回关键阶段耗时与当前状态（支持按 `request_id` 查询）
- 后端支持日志导出：下载完整日志与 tail 查看（便于交付现场排障）
- 后端支持一键诊断：音频依赖/后端连通/RAG/ASR/TTS/离线资产等关键项可快速判定
- 前端提供调试面板：展示事件时间线、关键耗时，并提供一键诊断入口
- 提供可交付的运维操作手册：启动方式、健康检查、导出与常见故障处理步骤

#### FR-6 验收条款
- 健康检查：访问 `/api/health` 返回 `ok=true`，并包含 `uptime_s` 等基础字段
- 状态查询：对任意一次问答/讲解拿到 `request_id` 后，访问 `/api/status?request_id=...` 能返回关键耗时（如 `submit_to_*`）
- 事件导出：访问 `/api/events?request_id=...&format=ndjson` 能导出该次请求的事件时间线
- 日志导出：
  - `/api/logs/download` 能下载后端日志文件
  - `/api/logs?tail_kb=...` 能查看 tail（默认 256KB）
- 一键诊断：访问 `/api/diag` 能返回至少：`deps.ffmpeg.found`、`ragflow.connected`、`asr.funasr_loaded`、`offline.items_count`
- 前端入口：前端调试面板存在“一键诊断/日志导出/事件导出”入口（不要求登录）

### FR-7 历史与复用
- 记录提问与回答；同问题计数聚合；点击历史可回填输入框

### FR-8 配置与站点管理
- 支持配置文件化管理：站点顺序、每站讲解时长、站点与导航点位的映射、外部服务地址与开关
- 支持导入/导出/备份配置；配置变更后无需改代码即可生效（允许重启服务生效）
- 站点数据至少包含：`stop_id/stop_name/duration_s`，并能与导航系统的站点 ID 对齐

### FR-9 降级与恢复
- 外部服务不可用（RAG/ASR/TTS 任一）时，系统应给出明确提示，并切换到可用模式：
  - 讲解：以“预录音整段离线播报”为主方案（可选开关）；至少保证文本展示可用
  - 问答：提示暂不可用，避免胡编；允许稍后重试
- 服务恢复后可自动或手动恢复到正常模式

#### FR-9 验收条款
- 入口与开关：
  - 前端存在“离线播报/停止离线”按钮；离线播报可被用户打断
  - 离线播报不依赖 RAG/ASR/TTS 在线可用（仅依赖本地音频资源）
- 允许降级的触发条件（满足其一即可进入离线播报）：
  - 现场网络/知识库不可用（RAG 无法连接或连续失败）
  - 音频链路异常（TTS 音频异常/无法播放），仍需保证文本可输出或离线播报可用
  - 运维人员人工选择离线模式（主动降级）
- 最小可用表现：
  - 离线播报开始后，能连续播放完整脚本（或至少按清单逐条播放），并能随时停止
  - 离线播报期间，新问题/切站等操作应能打断当前离线播报，避免“旧音频继续播放”
- 恢复方式：
  - 退出离线播报后，可回到在线问答/讲解流程；恢复后从当前站继续（不要求自动探测恢复）

- 离线资源准备（交付验收必备）：
  - 清单文件：`backend/data/offline/manifest.json` 必须存在，且 `items` 中每条至少包含 `id/order/filename`
  - 音频目录：`backend/data/offline/audio/` 下必须存在对应 `filename` 文件（建议 wav）
  - 缺资源表现：缺清单或缺音频时，前端“离线播报”应给出明确错误提示，不崩溃、不假播放

### FR-10 知识库接入与内容更新
- 支持对接知识库平台的数据集（dataset）与会话（chat/agent）的选择与切换（配置化）。
- 支持内容更新后的生效机制：更新知识库后，业务侧无需改代码即可使用新内容（允许重启服务生效）。
- 支持“来源可追溯”的返回：至少在运维侧可定位回答主要来自哪个文档/版本（若平台支持引用则启用）。

### FR-11 数据清洗与导入工具链
- 提供一套可复用的数据清洗与导入工具链（脚本/命令/文档皆可），覆盖：抽取、去噪、去重、分段、元数据标注、质量抽检。
- 支持增量导入（新增/更新文档），并保留版本号/日期，便于回滚与对比。
- 清洗与导入过程需可记录（输入文件列表、输出条目数、失败原因）。

### FR-12 权限与密钥管理
- 业务服务使用只读凭证访问知识库；导入/管理使用独立账号/凭证，避免混用。
- 支持密钥轮换：更换凭证后旧凭证可失效；支持在配置中切换。
- 运行中不得将密钥明文写入日志；日志仅记录凭证标识或前缀（如需）。

### FR-13 知识库平台部署与权限治理
- 知识库平台需可部署（内网或本机），并提供管理入口用于数据集/文档管理与权限配置。
- 至少支持三类角色：管理员、内容运营、只读访问（业务服务）。
- 支持审计留痕：记录导入/更新/删除等操作（时间、操作者、对象），并可导出。
- 支持备份与恢复（数据集导出/配置导出），便于版本回滚与现场快速恢复。

### FR-14 实施计划与人力投入
- 需给出软件实施计划（阶段划分、里程碑、每阶段交付物），并估算人力投入（人月）。
- 人力估算需能与软件详细设计条目对应，作为预算与排期依据。

## 3. 非功能需求
- NFR-1 延迟：首句播报尽可能 < 6s（现场网络允许时）
- NFR-2 稳定：长时间运行（>8h）不内存泄漏，不累积连接
- NFR-3 可维护：代码逻辑清晰
- NFR-4 可扩展：预留培训/教学接口方便日后扩展
- NFR-5 安全：配置与密钥最小暴露、关键操作可审计、敏感内容不外泄
