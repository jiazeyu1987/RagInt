# 软件详细设计（从软件需求拆解）

> 说明：本文从 `doc/robot/软件需求文档.md` 拆解而来，按 FR/NFR 编号逐条落到可实现的设计。本文描述软件架构、数据流、状态机与接口（对接 RAG/ASR/TTS/导航），并给出异常与降级策略。若系统侧接口/点位由第三方提供，以 `doc/robot/系统详细设计.md` 的“对接能力语义”为准。

> 标记规则（对照本仓库代码现状）：`[已实现]` / `[部分实现]` / `[未实现]` / `[文档项]`；每条尽量给出对应代码证据路径。

## 1. 需求对齐（FR/NFR → SD）

| 软件需求 | 对应软件详细设计条目（SD） |
|---|---|
| FR-1 连续讲解 | SD-1、SD-5、SD-8 |
| FR-2 观众问答（打断机制） | SD-2、SD-6 |
| FR-3 语音输入（ASR） | SD-3、SD-6 |
| FR-4 语音播报（TTS） | SD-4、SD-6 |
| FR-5 移动与站点到达 | SD-5、SD-6 |
| FR-6 运维与可观测性 | SD-6 |
| FR-7 历史与复用 | SD-7 |
| FR-8 配置与站点管理 | SD-8 |
| FR-9 降级与恢复 | SD-9 |
| FR-10 知识库接入与内容更新 | SD-12 |
| FR-11 数据清洗与导入工具链 | SD-13 |
| FR-12 权限与密钥管理 | SD-14 |
| FR-13 知识库平台部署与权限治理 | SD-15 |
| FR-14 实施计划与人力投入 | SD-16 |
| NFR-1 延迟 | SD-10 |
| NFR-2 稳定 | SD-10 |
| NFR-3 可维护 | SD-11 |
| NFR-4 可扩展 | SD-11 |
| NFR-5 安全 | SD-14 |

## SD-1 连续讲解（对应 FR-1）

> 实现状态：[已实现]（连续讲解 prompt/分段输出/站点时长与目标字数规划；连续讲解会话在打断后继续保持“连续模式”的衔接与预取）
> 代码证据：`backend/orchestrators/conversation_orchestrator.py`、`backend/services/tour_planner.py`、`fronted/src/managers/TourPipelineManager.js`、`fronted/src/managers/TourController.js`

### SD-1.1 讲解模型

- “讲解”视为对某个站点的讲解任务，输入为：
  - `stop_id/stop_name`
  - `duration_s`（每站讲解时长）
  - `style`（讲解风格：偏通俗/偏专业等，默认值即可）
  - `tail`（上一站结尾承接语，可选）
- 输出为：
  - 可展示的文本（增量）
  - 可播报的分段文本（按段落/句子分段）

### SD-1.2 讲解控制动作

控制动作（UI 按钮）对应内部事件：
- `start`：从第 1 站开始
- `pause`：暂停（停止播报/停止移动，保留当前进度）
- `continue`：继续当前站（若处于暂停）
- `next/prev/jump`：切换站点（需先走到目标站点，再开始讲解）
- `reset`：清空状态，回到 idle

### SD-1.3 承接策略（避免重复过渡）

- 保存上一站讲解尾句 `last_answer_tail`（例如最后 1~2 句）
- 若尾句含“接下来/下一站/欢迎来到”等过渡词，则在下一站开头压缩/清空尾句，减少撞词
- 下一站 prompt 加入：
  - 站点名称、本站时长
  - “衔接要求”（连续模式下避免固定话术）

## SD-2 问答与打断机制（对应 FR-2）

> 实现状态：[已实现]（request_id 级取消；interrupt 可停止播放/停止 SSE/取消后端；补齐 ASR 上传/识别中止；服务端支持按 client_id 取消全部活跃请求 kind=all）
> 代码证据：`backend/services/request_registry.py`、`backend/infra/cancellation.py`、`backend/app.py`（`/api/cancel`、`/api/ask`）、`fronted/src/managers/AskWorkflowManager.js`、`fronted/src/hooks/useRecorderWorkflow.js`、`fronted/src/api/backendClient.js`、`fronted/src/App.js`

### SD-2.1 request_id 与 run_id

- 每次问答/讲解请求生成 `request_id`（用于全链路追踪与取消）
- 前端（控制端）保存当前活动 `request_id` 与 `run_id`
- 新请求进入时：
  - 立刻触发 `interrupt()`：停止播放、终止 SSE、取消移动（如在移动）
  - 发送 `cancel(request_id)` 到服务端（服务端必须让 in-flight 处理尽快退出）

### SD-2.2 取消的范围

取消必须覆盖：
- 正在进行的问答/讲解文本流（RAG/SSE）
- TTS 合成请求（若已发起）
- 音频播放（控制端）
- ASR（若在录音/上传/识别）
- 移动（若正在前往站点）

### SD-2.3 问答结束后的继续策略

- 问答结束后，提供两个恢复入口：
  - “继续当前站讲解”（补充未讲完的点）
  - “进入下一站”（切站并讲解）
- 恢复时仍遵循承接策略（避免重复开场）

## SD-3 语音输入（ASR）（对应 FR-3）

> 实现状态：[已实现]（前端录音上传；后端转码到 16k mono + 多 provider ASR + 可取消/限流）
> 代码证据：`fronted/src/managers/RecorderManager.js`、`fronted/src/hooks/useRecorderWorkflow.js`、`backend/app.py`（`/api/speech_to_text`）、`backend/services/asr_service.py`

### SD-3.1 交互策略

- 语音输入默认流程：
  1) 按住说话/点击开始录音
  2) 结束录音后上传识别
  3) 识别结果回填到输入框（不自动提交）
- 识别失败提示：
  - 显示/播报：“我没听清，请再说一遍”
  - 提供“重试”和“手动输入”入口

### SD-3.2 音频处理约定

- 采样率统一到 16k mono（如录音为 48k/双声道，控制端需转码）
- 上传格式以浏览器可用为准（webm/ogg/mp4），服务端负责兼容解码或要求控制端转 wav

## SD-4 语音播报（TTS）（对应 FR-4）

> 实现状态：[已实现]（流式 TTS + 分段队列播放 + 中断清空；白噪/静音/削波等异常音频探测后自动降级为“仅文本 + 可重试”，并保留回退播放链路）
> 代码证据：`backend/app.py`（`/api/text_to_speech_stream`）、`backend/services/tts_service.py`、`fronted/src/managers/TtsQueueManager.js`、`fronted/src/managers/createTtsManager.js`、`fronted/src/audio/ttsAudio.js`、`fronted/src/App.js`

### SD-4.1 流式播报与分段

- 播报以“段”为单位：每个段落独立合成并立刻播放（边合成边播）
- 段落来源：
  - 优先使用服务端输出的 `segment`
  - 若无 segment，控制端可按标点/字数做兜底分段（但优先以服务端分段为准）

### SD-4.2 播放控制

- 播放队列支持：
  - 清空队列
  - 快速停止当前音频
  - 禁止重入（同一时刻只允许一个播放 run）
- 打断触发后：
  - 必须停止当前播放
  - 丢弃所有未播放的段落与未完成的合成请求

### SD-4.3 白噪音与卡顿控制

- 采样率统一（建议 16k）
- 流式 wav 处理：只处理首段 header，后续只喂 PCM（避免重复 header 造成噪音）
- 异常音频：检测连续静音/异常幅度，触发降级（仅文本展示 + 可重试）

## SD-5 移动与站点到达（对应 FR-5、关联 FR-1）

> 实现状态：[部分实现]（已实现“站点/路线规划 + 讲解编排/切站”；未实现导航/底盘对接、到站判定、移动失败恢复等能力）
> 代码证据：`backend/services/tour_planner.py`、`backend/app.py`（`/api/tour/*`）、`fronted/src/managers/TourController.js`；仓库内未发现导航/底盘控制相关服务或 API（如 `/api/move`）

### SD-5.1 对接方式

- 软件侧只依赖“对接能力语义”，不绑定协议细节：
  - `go_to(stop_id)`：前往某站点
  - `cancel()`：取消移动
  - `get_state()`：查询状态（idle/moving/arrived/failed/cancelled/estop）
- 站点 ID 以配置为准，与第三方站点清单一致

### SD-5.2 讲解与移动联动

- 切站动作（next/prev/jump/start）流程：
  1) 触发移动到目标站点
  2) 监听到站（arrived）后触发该站讲解请求
  3) 移动失败（failed/estop/timeout）则停止并提示人工介入，不进入讲解

### SD-5.3 异常处理

- `failed`：提示“移动失败，请人工协助”，并提供“重试移动/跳过该站/暂停”按钮
- `estop`：进入锁定状态，提示“急停已触发”，必须人工复位后才能继续

## SD-6 运维与可观测性（对应 FR-6、关联 FR-2/3/4/5）

> 实现状态：[已实现]（覆盖 SD-6.1/6.2：request_id/client_id/stop/action 记录，提交→首字→首段→TTS首包→播报结束时间线，nav_* 事件，调试面板展示与 NDJSON 导出；并补齐日志导出/健康检查/一键诊断与运维手册）
> 代码证据：`backend/app.py`（`/api/status`、`/api/events`、`/api/client_events`、`/api/ask`、`/api/text_to_speech_stream`、`/api/logs*`、`/api/diag`、`/api/health`）、`backend/infra/event_store.py`、`backend/services/request_registry.py`、`fronted/src/components/DebugPanel.js`、`doc/robot/运维交付操作手册.md`

### SD-6.1 关键指标（建议最小集）

每次请求至少记录：
- `request_id`、`client_id`、`stop_id/stop_name`、动作类型（讲解/问答/切站）
- 时间线（建议字段）：
  - `t_submit`（提交）
  - `t_rag_first`（获取到第一段内容）
  - `t_first_segment`（第一段可播报文本产生）
  - `t_tts_first_audio`（第一包音频到达）
  - `t_play_end`（播报完成）
- 移动状态事件：
  - `nav_start/nav_arrived/nav_failed/nav_cancelled/estop`

#### SD-6.1.1 指标口径表（避免扯皮）

| 指标 | 来源 | 计算口径 | 依赖 | 验收方式 |
|---|---|---|---|---|
| `submit_to_rag_first_text_ms` | 后端 `/api/status` | `t_ragflow_first_text - t_submit` | 无 | 发起一次问答后，查询 `/api/status?request_id=...` |
| `submit_to_first_segment_ms` | 后端 `/api/status` | `t_first_tts_segment - t_submit` | 无 | 同上 |
| `submit_to_tts_first_audio_ms` | 后端 `/api/status` | `t_tts_first_audio - t_submit` | 无 | 同上 |
| `submit_to_play_end_ms` | 后端 `/api/status` | `t_play_end - t_submit` | 前端需回传 `play_end` 事件 | 同上 |
| 事件时间线导出 | 后端 `/api/events` | NDJSON 每行一个 event（含 `ts_ms/kind/name/fields`） | 无 | `/api/events?request_id=...&format=ndjson` |
| 一键诊断 | 后端 `/api/diag` | 返回依赖/连通/离线资产概况 | 无 | 访问 `/api/diag` |
| 日志导出 | 后端 `/api/logs*` | `download` + `tail` | 无 | 访问 `/api/logs/download` 与 `/api/logs?tail_kb=...` |

### SD-6.2 调试面板

调试面板至少展示：
- 当前站点与移动状态
- 当前请求的关键耗时与是否已取消
- 最近一次失败原因（ASR/TTS/RAG/移动）
- 一键诊断入口与日志导出入口（交付运维使用）

## SD-7 历史与复用（对应 FR-7）

> 实现状态：[已实现]（问答历史落库 + 查询接口；前端可展示）
> 代码证据：`backend/services/history_store.py`、`backend/app.py`（`/api/history`）、`fronted/src/components/HistoryPanel.js`

- 保存：`question/answer/created_at/stop_id（可选）/mode（讲解或问答）`
- 聚合：同问题计数、按最近时间排序
- 交互：点击历史问题回填到输入框
- 清理：提供保留条数或按天清理策略（与运维策略一致）

## SD-8 配置与站点管理（对应 FR-8）

> 实现状态：[部分实现]（支持从配置读取站点/路线/偏好并生成计划；未实现“可视化配置编辑/导入导出/权限控制”等管理能力）
> 代码证据：`backend/services/tour_planner.py`、`backend/app.py`（`/api/tour/meta`、`/api/tour/plan`、`/api/tour/stops`）、`ragflow_demo/ragflow_config.json`

### SD-8.1 配置项范围

配置文件至少包含：
- 站点列表（顺序、`stop_id`、`stop_name`、`duration_s`）
- 外部依赖开关与地址（RAG/ASR/TTS，可本机/内网）
- 导航对接地址（若需要）
- 运行参数（日志级别、超时、重试次数）

### SD-8.2 配置生效方式

- 支持导入/导出/备份（生成带时间戳的备份）
- 配置变更后允许“重启服务生效”（不强制在线热更新）
- 配置校验：缺字段/格式错时给出明确错误，不启动或进入安全默认配置

## SD-9 降级与恢复（对应 FR-9）

> 实现状态：[部分实现]（已支持“离线播报：整段预录音脚本按顺序播放 + 可打断”，作为当前确认的降级主方案；自动降级触发/恢复探测仍未形成完整闭环；离线“脚本文本兜底”作为可选项/下一期）
> 代码证据：`backend/app.py`（`/api/offline/manifest`、`/api/offline/audio/<id>`）、`backend/services/offline_script_service.py`、`backend/data/offline/manifest.json`、`fronted/src/managers/OfflineScriptPlayer.js`、`fronted/src/components/ControlBar.js`

### SD-9.1 降级触发条件

- RAG 不可用（超时/错误/返回空）
- ASR 不可用（连续失败/设备不可用）
- TTS 不可用（返回失败/音频异常）

#### SD-9.1.1 触发判定表（明确入口）

| 触发源 | 触发条件（示例） | 系统行为 | 退出/恢复 |
|---|---|---|---|
| 运维人工 | 点击“离线播报” | 立即打断当前 run，开始按清单播放离线预录音 | 点击“停止离线”，回到在线模式 |
| RAG 异常 | `ragflow.connected=false` 或持续失败/超时 | 提示在线不可用；允许人工进入离线播报 | 由人工停止离线后恢复在线 |
| 音频异常 | 检测到白噪/静音/削波等异常导致不可播 | 降级为“仅文本”（在线）或由人工切离线播报 | 文本继续可用；或人工切离线 |

### SD-9.2 降级策略

- 讲解降级（主方案）：整段预录音离线播报（按清单顺序播放，可打断）
- 讲解降级（可选/下一期）：本地脚本文本兜底（按站点准备简短讲解文本），至少能显示文本（若 TTS 可用可播报）
- 问答降级：提示“暂时无法联网检索/系统繁忙，请稍后重试或咨询工作人员”，避免胡编
- 恢复策略：
  - 定时探测服务恢复（或人工点击“恢复在线模式”）
  - 恢复后从当前站继续，避免重复开场

#### SD-9.2.1 降级/恢复流程表（现场可执行）

| 场景 | 用户可见提示 | 可用操作 | 关键约束 |
|---|---|---|---|
| 在线正常 | 正常问答/讲解 | 开始/暂停/继续/切站/离线播报 | 新请求进入必须能取消旧 run |
| 在线异常（RAG/网络） | 在线不可用提示 | 切离线播报 / 稍后重试 | 不允许胡编；可用明确兜底话术 |
| 在线异常（音频） | “音频异常：已降级为仅文本（可重试）” | 仅文本继续 / 切离线播报 | 不应继续播放异常音频 |
| 离线播报中 | “离线播报中…” | 停止离线 / 打断 / 切站 | 离线播报必须可打断，避免旧音频残留 |

## SD-10 非功能：性能与稳定（对应 NFR-1/NFR-2）

> 实现状态：[部分实现]（有 rate limit、关键时延埋点与状态查询；补齐了日志导出/一键诊断/运维手册；但未见系统化压测/长期稳定性守护进程/自动化巡检脚本落地）
> 代码证据：`backend/services/request_registry.py`（rate limit）、`backend/app.py`（timings + `/api/status` + `/api/diag` + `/api/logs*`）、`fronted/src/components/DebugPanel.js`（一键诊断入口）、`doc/robot/运维交付操作手册.md`

- 首句可听时间目标：在现场网络可用时，尽量在 6s 内听到首句（以 P50/P90 指标统计）
- 运行稳定：长时间运行不应出现连接堆积、内存持续增长
- 保护措施：
  - SSE/音频流都要支持超时与取消
  - 并发限制：同一控制端同一时刻只允许一个“活动 run”
  - 失败重试：外部服务重试次数有限，避免无限重试导致系统抖动

## SD-11 非功能：可维护与可扩展（对应 NFR-3/NFR-4）

> 实现状态：[部分实现]（服务拆分为 services/orchestrators/infra；但适配层/插件化与更严格的接口抽象仍偏文档预期）
> 代码证据：`backend/services/*`、`backend/orchestrators/conversation_orchestrator.py`、`fronted/src/managers/*`

- 模块划分建议：
  - UI/控制层（讲解控制、录音、播放）
  - 编排层（讲解/问答/切站流程）
  - 适配层（RAG/ASR/TTS/导航）
  - 存储层（历史/配置/日志）
- 预留扩展点：
  - 新增站点与脚本无需改代码（只改配置）
  - 外部服务替换只影响适配层（不改编排层）

## SD-12 知识库接入与内容更新（对应 FR-10）

> 实现状态：[部分实现]（已实现 RAGFlow 调用侧：chat/agent 列表、会话创建、流式问答；内容更新/导入链路不在本仓库内闭环）
> 代码证据：`backend/services/ragflow_service.py`、`backend/services/ragflow_agent_service.py`、`backend/app.py`（`/api/ragflow/*`、`/api/ask`）、`ragflow_demo/ragflow_config.json`

### SD-12.1 知识库对象模型

- 核心对象：
  - `dataset`：展厅知识库数据集（按企业/展区/产品线划分均可，建议先一个主数据集）
  - `chat` 或 `agent`：面向讲解/问答的会话/智能体配置（由平台能力决定）
- 业务侧配置项（配置化，不写死在代码里）：
  - 知识库平台地址（base_url）
  - 访问凭证（只读 key/token）
  - 默认数据集/默认会话（以及可选的候选列表）

### SD-12.2 生效与切换策略

- 配置变更（切数据集/切会话）：
  - 最小实现：重启服务生效
  - 可选增强：热加载（需保证并发安全与回滚能力）
- 内容更新生效：
  - 由知识库平台完成索引刷新；业务侧只需重试/刷新会话即可使用最新内容

### SD-12.3 可追溯性（运维侧）

- 若平台支持引用（citation/source），业务侧应保留并在运维日志中记录：
  - 命中的文档名/版本/片段编号（避免在用户界面泄露敏感信息）
- 若平台不支持引用，至少记录：
  - 当前 dataset/version 标识、请求时间、会话配置

## SD-13 数据清洗与导入工具链（对应 FR-11）

> 实现状态：[未实现]（仓库内未提供“抽取/清洗/OCR/入库/版本/回滚”的可执行脚本或流水线；现有 `ragflow_demo/text_cleaner.py` 偏向 TTS 分段/清洗）
> 代码证据：`ragflow_demo/text_cleaner.py`（非入库工具链）；未发现独立导入/清洗工具目录或命令

> 本节关注“怎么把资料变成可检索的知识库内容”。工具形态可以是脚本、命令、或平台内置导入流程，但必须可重复执行、可回滚。

### SD-13.1 输入与输出

- 输入：原始资料（PPT/Word/PDF/手册/FAQ/参数表/展板文案）
- 输出：
  - 可导入的文本块（chunk）与元数据（JSON/CSV/平台导入格式）
  - 导入记录（版本号、数量、失败原因）

### SD-13.2 清洗规则（最小集）

1) 抽取：文本抽取 + 扫描件 OCR（如有）
2) 去噪：页眉页脚、目录、页码、重复标题、乱码
3) 统一：全角/半角、标点、空白、单位格式（例如 mm/厘米）
4) 去重：同段落/同句相似内容去重
5) 分段：按标题层级/自然段切分，长度建议 200~600 字（按平台调参）
6) 元数据：`source/version/category/sensitivity` 至少四类
7) 抽检：随机抽样若干条检索验证（可用 10~30 条起步）

### SD-13.3 增量更新与回滚

- 增量：新增/替换某个资料时，只更新对应来源与版本，不影响其他来源
- 回滚：保留上一版本数据集（或可通过版本号回滚），确保现场问题可快速恢复
- 记录：每次导入生成导入清单（文件列表、条目数、版本号、操作者）

## SD-14 权限、密钥与安全（对应 FR-12、NFR-5）

> 实现状态：[未实现]（当前以本地配置文件读取为主，未形成“凭证分离/轮换/审计/避免明文入库与日志脱敏”的完整实现）
> 代码证据：`backend/services/ragflow_service.py`（读取 `ragflow_demo/ragflow_config.json`）、`backend/app.py`（`load_app_config()` 直接加载配置）

### SD-14.1 凭证分离

- 业务服务：只读凭证（仅用于检索/问答）
- 内容导入：独立的运营/管理员凭证（可写入数据集、可管理文档）
- 严禁将管理员凭证放入机器人现场运行环境

### SD-14.2 密钥存储与轮换

- 存储：
  - 允许配置文件/环境变量二选一，但必须避免明文出现在代码仓库
  - 日志中不得打印完整密钥
- 轮换：
  - 支持切换新 key/token 后旧 key 失效
  - 轮换过程提供回退方案（保留旧 key 但限制使用窗口）

### SD-14.3 操作审计与敏感内容边界

- 导入/删除/更新动作需有审计记录（平台侧为主，业务侧记录摘要即可）
- 敏感内容：
- 通过数据清洗阶段的 `sensitivity` 标记与平台权限控制
- 业务侧在提示与输出中避免泄露内部敏感字段（例如价格、未公开信息）

## SD-15 知识库平台部署与权限治理（对应 FR-13）

> 实现状态：[文档项]（部署/治理属于交付方案与平台侧能力，本仓库仅包含调用侧代码与配置示例）

> 目标：把“知识库平台可用、可管理、可审计、可回滚”这部分作为软件交付的一部分，确保内容可持续迭代，而不是一次性导入。

### SD-15.1 部署形态

- 单机部署：知识库平台与业务服务在同一台主机运行（适合快速落地，但维护与备份压力较大）。
- 内网部署（推荐）：知识库平台部署在内网服务器/虚拟机，机器人侧仅通过只读凭证访问，便于集中维护与备份。

### SD-15.2 角色与权限

至少三类角色：
- 管理员：平台配置、用户/密钥管理、数据集权限配置
- 内容运营：文档导入/更新、查看导入结果
- 只读访问：业务服务调用检索/问答，不具备导入权限

### SD-15.3 审计与备份

- 审计：导入/更新/删除应有留痕（时间、操作者、数据集/文档），可在平台侧查询或导出。
- 备份与回滚：
  - 至少支持数据集导出与配置导出
  - 版本回滚可按“版本号/日期”恢复到上一可用版本

### SD-15.4 敏感内容治理（与 SD-14 配合）

- 在清洗与元数据阶段标记 `sensitivity`（公开/内部）
- 平台侧按角色限制可见范围；业务侧默认只读访问不应命中内部敏感数据

## SD-16 实施计划与人力投入（对应 FR-14）

> 实现状态：[文档项]（项目计划/投入估算，不对应代码实现）

> 目的：给预算与排期提供可解释依据。人力按人月估算，实际以站点数量、知识库资料规模、外部服务部署方式为准。

### SD-16.1 阶段划分（建议）

| 阶段 | 覆盖的 SD 条目 | 主要工作内容 | 主要交付物 | 建议人月（合计） |
|---|---|---|---|---:|
| S1 基础框架与配置 | SD-8、SD-6 | 配置结构、日志/指标框架、环境参数与密钥加载 | 配置模板、日志与指标最小集 | 0.5 |
| S2 讲解/问答编排 | SD-1、SD-2、SD-9 | 讲解流程、打断机制、降级策略落地 | 连续讲解与打断可用、降级可用 | 2.0 |
| S3 语音链路 | SD-3、SD-4 | 录音上传、分段播报、播放中断与稳定性处理 | 语音输入/播报闭环 | 1.5 |
| S4 移动联动 | SD-5 | 切站触发移动、到站后讲解、失败提示与恢复路径 | 切站联动可用 | 1.0 |
| S5 知识库建设与权限 | SD-12、SD-13、SD-14、SD-15 | 平台部署、清洗入库、增量更新、权限/审计、可追溯 | 首版知识库可用、更新与权限可用 | 2.0 |
| S6 测试与交付 | SD-6、SD-10、SD-11 | 指标验证、稳定性测试、运行手册与操作说明 | 交付包、测试报告、运维手册 | 1.0 |
|  |  |  | **合计** | **8.0** |


