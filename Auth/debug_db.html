<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æ•°æ®åº“è°ƒè¯•å·¥å…·</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .section { background: white; padding: 15px; margin: 10px 0; border-radius: 5px; }
        h2 { margin-top: 0; color: #333; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #4CAF50; color: white; }
        tr:nth-child(even) { background: #f2f2f2; }
        .user-id { font-size: 11px; color: #666; }
        .match-yes { color: green; font-weight: bold; }
        .match-no { color: red; font-weight: bold; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ” æ•°æ®åº“è°ƒè¯•å·¥å…·</h1>

    <div class="section">
        <h2>æ‰€æœ‰ç”¨æˆ·</h2>
        <div id="users">åŠ è½½ä¸­...</div>
    </div>

    <div class="section">
        <h2>intlifeçŸ¥è¯†åº“çš„æ–‡æ¡£</h2>
        <div id="documents">åŠ è½½ä¸­...</div>
    </div>

    <div class="section">
        <h2>åŸå§‹JSONæ•°æ®</h2>
        <pre id="raw-data">åŠ è½½ä¸­...</pre>
    </div>

    <script>
        async function loadData() {
            try {
                // åŠ è½½ç”¨æˆ·åˆ—è¡¨
                const usersRes = await fetch('http://localhost:8001/api/users', {
                    credentials: 'include'
                });
                const users = await usersRes.json();

                // åŠ è½½æ–‡æ¡£åˆ—è¡¨
                const docsRes = await fetch('http://localhost:8001/api/knowledge/documents?kb_id=intlife', {
                    credentials: 'include'
                });
                const docsData = await docsRes.json();

                // æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨
                let usersHtml = '<table><tr><th>ç”¨æˆ·å</th><th>user_id</th><th>è§’è‰²</th></tr>';
                users.forEach(u => {
                    usersHtml += `<tr>
                        <td><strong>${u.username}</strong></td>
                        <td class="user-id">${u.user_id}</td>
                        <td>${u.role}</td>
                    </tr>`;
                });
                usersHtml += '</table>';
                document.getElementById('users').innerHTML = usersHtml;

                // æ˜¾ç¤ºæ–‡æ¡£åˆ—è¡¨
                const userMap = {};
                users.forEach(u => userMap[u.user_id] = u.username);

                let docsHtml = '<table><tr><th>æ–‡ä»¶å</th><th>ä¸Šä¼ è€…</th><th>å®¡æ ¸è€…</th><th>çŠ¶æ€</th></tr>';
                docsData.documents.forEach(doc => {
                    const uploader = userMap[doc.uploaded_by];
                    const reviewer = doc.reviewed_by ? userMap[doc.reviewed_by] : null;

                    docsHtml += `<tr>
                        <td>${doc.filename}</td>
                        <td>
                            ${uploader ?
                                `<span class="match-yes">âœ“ ${uploader}</span>` :
                                `<span class="match-no">âœ— æœªæ‰¾åˆ° (${doc.uploaded_by})</span>`}
                            <br><span class="user-id">${doc.uploaded_by}</span>
                        </td>
                        <td>
                            ${doc.reviewed_by ?
                                (reviewer ?
                                    `<span class="match-yes">âœ“ ${reviewer}</span>` :
                                    `<span class="match-no">âœ— æœªæ‰¾åˆ° (${doc.reviewed_by})</span>`) :
                                '<span style="color: #999;">NULL (æœªå®¡æ ¸)</span>'}
                            ${doc.reviewed_by ? `<br><span class="user-id">${doc.reviewed_by}</span>` : ''}
                        </td>
                        <td>${doc.status}</td>
                    </tr>`;
                });
                docsHtml += '</table>';
                document.getElementById('documents').innerHTML = docsHtml;

                // æ˜¾ç¤ºåŸå§‹æ•°æ®
                document.getElementById('raw-data').textContent = JSON.stringify({
                    users: users,
                    documents: docsData.documents
                }, null, 2);

            } catch (error) {
                document.getElementById('users').innerHTML = `<p style="color: red;">é”™è¯¯: ${error.message}</p>`;
                document.getElementById('documents').innerHTML = '';
                document.getElementById('raw-data').textContent = error.stack;
            }
        }

        loadData();
    </script>
</body>
</html>
